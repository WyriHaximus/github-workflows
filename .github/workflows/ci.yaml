name: Continuous Integration
on:
  workflow_call:
    inputs:
      jsonPattern:
        description: The pattern to match which JSON files to check
        default: "\\.json$"
        required: false
        type: string
      workingDirectory:
        description: The directory to run this workflow in
        default: ""
        required: false
        type: string

#defaults:
#  run:
#    working-directory: ${{ inputs.workingDirectory }}

jobs:
#  lint-yaml:
#    name: Lint YAML
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v3
#      - name: yaml-lint
#        uses: ibiqlik/action-yamllint@v3
#        with:
#          config_data: |
#            extends: default
#            ignore: |
#              /.git/
#            rules:
#              line-length: disable
#              document-start: disable
#              truthy: disable
#  lint-json:
#    name: Lint JSON
#    runs-on: ubuntu-latest
#    steps:
#      - uses: actions/checkout@v3
#      - name: json-syntax-check
#        uses: limitusus/json-syntax-check@v2
#        with:
#          pattern: inputs.jsonPattern
  package-name:
    runs-on: ubuntu-latest
#    needs:
#      - lint-json
    outputs:
      package-name: ${{ steps.package-name.outputs.package-name }}
    steps:
      - uses: actions/checkout@v3
      - id: package-name
        working-directory: ${{ inputs.workingDirectory }}
        run: |
          printf "::set-output name=package-name::[\"%s\"]" $(docker run --rm -v "`pwd`:`pwd`" jess/jq jq -r -c '.name' "$(pwd)/composer.json")
  supported-versions-matrix:
    name: Supported Versions Matrix
    runs-on: ubuntu-latest
#    needs:
#      - lint-yaml
#      - lint-json
    outputs:
      version: ${{ steps.supported-versions-matrix.outputs.version }}
      upcoming: ${{ steps.supported-versions-matrix.outputs.upcoming }}
      extensions: ${{ steps.supported-versions-matrix.outputs.extensions }}
    steps:
      - uses: actions/checkout@v3
      - id: supported-versions-matrix
        uses: WyriHaximus/github-action-composer-php-versions-in-range@v1
        with:
          upcomingReleases: true
          working-directory: ${{ inputs.workingDirectory }}
  supported-threading-matrix:
    name: Supported Threading Matrix
    runs-on: ubuntu-latest
    needs:
      - supported-versions-matrix
    outputs:
      version: ${{ steps.supported-threading-matrix.outputs.result }}
    steps:
      - uses: actions/checkout@v3
      - id: supported-threading-matrix
        uses: actions/github-script@v7
        env:
          PHP_EXTENSIONS: ${{ needs.supported-versions-matrix.outputs.extensions }}
        with:
          script: |
            const phpExtensions = JSON.parse(process.env.PHP_EXTENSIONS);
            for(var i = 0; i <= phpExtensions.length; i++) {
                if (phpExtensions[i] == 'parallel') { 
                  return ['zts'];
                }
            }
            return ['nts', 'zts'];
  supported-checks-matrix:
    name: Supported Checks Matrix
    runs-on: ubuntu-latest
#    needs:
#      - lint-yaml
    outputs:
      check: ${{ steps.supported-checks-matrix.outputs.check }}
    steps:
      - uses: actions/checkout@v3
      - id: supported-checks-matrix
        name: Generate check
        run: |
          printf "Checks found: %s\r\n" $(make task-list-ci)
          printf "::set-output name=check::%s" $(make task-list-ci)
        working-directory: ${{ inputs.workingDirectory }}
  can-require:
    name: Test we can require "${{ matrix.package-name }}" on PHP ${{ matrix.php }} (${{ matrix.php-to-thread-or-not-to-thread }})
    strategy:
      fail-fast: false
      matrix:
        php: ${{ fromJson(needs.supported-versions-matrix.outputs.version) }}
        php-to-thread-or-not-to-thread: ${{ fromJson(needs.supported-threading-matrix.outputs.version) }}
        package-name: ${{ fromJson(needs.package-name.outputs.package-name) }}
    needs:
#      - lint-yaml
#      - lint-json
      - package-name
      - supported-versions-matrix
      - supported-threading-matrix
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/wyrihaximusnet/php:${{ matrix.php }}-${{ matrix.php-to-thread-or-not-to-thread }}-alpine-dev-root
    steps:
      - uses: actions/checkout@v3
        with:
          path: checked_out_package
      - name: Set Up composer.json
        run: |
          echo "{\"repositories\": [{\"name\": \"${{ matrix.package-name }}\",\"type\": \"path\",\"url\": \"./checked_out_package\"}]}" > composer.json
        working-directory: ${{ inputs.workingDirectory }}
      - name: Require package
        if: needs.supported-versions-matrix.outputs.upcoming != matrix.php
        run: |
          composer config --no-plugins "allow-plugins.*/*" true
          composer require "${{ matrix.package-name }}:dev-${GITHUB_SHA}" --no-progress --ansi --no-interaction --prefer-dist --no-plugins -o -vvv || composer require "${{ matrix.package-name }}:dev-${GITHUB_REF_NAME}" --no-progress --ansi --no-interaction --prefer-dist --no-plugins -o -vvv
        working-directory: ${{ inputs.workingDirectory }}
  qa:
    name: Run ${{ matrix.check }} on PHP ${{ matrix.php }} (${{ matrix.php-to-thread-or-not-to-thread }}) with ${{ matrix.composer }} dependency preference
    strategy:
      fail-fast: false
      matrix:
        php: ${{ fromJson(needs.supported-versions-matrix.outputs.version) }}
        php-to-thread-or-not-to-thread: ${{ fromJson(needs.supported-threading-matrix.outputs.version) }}
        composer: [lowest, locked, highest]
        check: ${{ fromJson(needs.supported-checks-matrix.outputs.check) }}
    needs:
#      - lint-yaml
#      - lint-json
      - supported-checks-matrix
      - supported-versions-matrix
      - supported-threading-matrix
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/wyrihaximusnet/php:${{ matrix.php }}-${{ matrix.php-to-thread-or-not-to-thread }}-alpine-dev-root
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Required due to the way Git works, without it this action won't be able to find any or the correct tags
      - uses: ramsey/composer-install@v2
        with:
          dependency-versions: ${{ matrix.composer }}
          working-directory: ${{ inputs.workingDirectory }}
      - run: git config --global --add safe.directory $GITHUB_WORKSPACE # Do this ourself because `actions/checkout@v3 doesn't succeed in doing this
        working-directory: ${{ inputs.workingDirectory }}
      - run: make ${{ matrix.check }} || true
        working-directory: ${{ inputs.workingDirectory }}
        if: needs.supported-versions-matrix.outputs.upcoming == matrix.php
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
          COVERALLS_RUN_LOCALLY: ${{ secrets.COVERALLS_RUN_LOCALLY }}
      - run: make ${{ matrix.check }}
        working-directory: ${{ inputs.workingDirectory }}
        if: needs.supported-versions-matrix.outputs.upcoming != matrix.php
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
          COVERALLS_RUN_LOCALLY: ${{ secrets.COVERALLS_RUN_LOCALLY }}
  tests-directly-on-os:
    name: Run tests on PHP ${{ matrix.php }} with ${{ matrix.composer }} dependency preference (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        php: ${{ fromJson(needs.supported-versions-matrix.outputs.version) }}
        php-to-thread-or-not-to-thread: ${{ fromJson(needs.supported-threading-matrix.outputs.version) }}
        composer: [lowest, locked, highest]
    needs:
#      - lint-yaml
#      - lint-json
      - supported-checks-matrix
      - supported-versions-matrix
      - supported-threading-matrix
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - uses: shivammathur/setup-php@v2
        env:
          phpts: ${{ matrix.php-to-thread-or-not-to-thread }}
        with:
          php-version: ${{ matrix.php }}
          coverage: pcov
          extensions: ${{ join(fromJson(needs.supported-versions-matrix.outputs.extensions), ',') }}
      - uses: ramsey/composer-install@v2
        with:
          dependency-versions: ${{ matrix.composer }}
          working-directory: ${{ inputs.workingDirectory }}
      - run: make unit-testing-raw || true
        working-directory: ${{ inputs.workingDirectory }}
        if: needs.supported-versions-matrix.outputs.upcoming == matrix.php
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
          COVERALLS_RUN_LOCALLY: ${{ secrets.COVERALLS_RUN_LOCALLY }}
      - run: make unit-testing-raw
        working-directory: ${{ inputs.workingDirectory }}
        if: needs.supported-versions-matrix.outputs.upcoming != matrix.php
        env:
          COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
          COVERALLS_RUN_LOCALLY: ${{ secrets.COVERALLS_RUN_LOCALLY }}
  check-mark:
    name: ✔️
    needs:
#      - lint-yaml
#      - lint-json
      - can-require
      - qa
      - tests-directly-on-os
    runs-on: ubuntu-latest
    steps:
      - run: echo "✔️"
