name: Serverless Diff

on:
  workflow_call:
    inputs:
      workingDirectory:
        description: The directory to run this workflow in
        default: ""
        required: false
        type: string
      runsOn:
        description: Define on which runner to run workflows where order doesn't matter should run
        default: "ubuntu-latest"
        required: true
        type: string
      serverlessSparseCheckout:
        description: Additional files/patterns for the sparse checkout
        default: ""
        required: false
        type: string
      awsAccessKeyIDSecret:
        description: The secret name that holds the AWS access key ID
        default: "SERVERLESS_KEY"
        required: true
        type: string
      awsSecretAccessKeySecret:
        description: The secret name that holds the AWS access key secret
        default: "SERVERLESS_SECRET"
        required: true
        type: string
      awsRegionSecret :
        description: The secret name that holds the AWS region
        default: "SERVERLESS_REGION"
        required: true
        type: string
jobs:
  serverless-diff:
    name: Serverless Diff
    runs-on: ${{ inputs.runsOn }}
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5
        with:
          sparse-checkout-cone-mode: false
          sparse-checkout: |
            !${{ inputs.workingDirectory }}/*
            /${{ inputs.workingDirectory }}composer.json
            /${{ inputs.workingDirectory }}composer.lock
            /${{ inputs.workingDirectory }}serverless.yml
            ${{ inputs.serverlessSparseCheckout }}
      - name: Get desired PHP version
        id: supported-versions-matrix
        uses: WyriHaximus/github-action-composer-php-versions-in-range@d037519ac6672bf126b1335dcff5f1fd0062658e # v1.15.0
      - name: Install PHP
        uses: shivammathur/setup-php@verbose
        env:
          fail-fast: true
          runner: self-hosted
        with:
          php-version: "${{ steps.supported-versions-matrix.outputs.lowest }}"
          coverage: "none"
          extensions: ${{ join(fromJson(steps.supported-versions-matrix.outputs.extensions), ',') }}
      - name: Install Dependencies
        uses: ramsey/composer-install@3cf229dc2919194e9e36783941438d17239e8520 # 3.1.1
        with:
          working-directory: ${{ inputs.workingDirectory }}
          composer-options: "--prefer-dist --optimize-autoloader --no-dev --no-scripts"
      - uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          aws-access-key-id: ${{ secrets[inputs.awsAccessKeyIDSecret] }}
          aws-secret-access-key: ${{ secrets[inputs.awsSecretAccessKeySecret] }}
          aws-region: ${{ secrets[inputs.awsRegionSecret] }}
      - name: Diff
        id: diff
        run: |
            npm install -g serverless-plugin-diff@3
            delimiter="$(openssl rand -hex 8)"
            echo "diff<<${delimiter}" >> "${GITHUB_OUTPUT}"
            echo "$(serverless diff --stage=prod)" >> "${GITHUB_OUTPUT}"
            echo "${delimiter}" >> "${GITHUB_OUTPUT}"
      - name: 'Upsert comment'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: serverless-diff
          message: |
            Serverless Diff:
            ```diff
            ${{ steps.diff.outputs.diff }}
            ```
