name: TerraForm Diff
env: ${{ vars }}
on:
  workflow_call:
    inputs:
      runsOn:
        description: Define on which runner this workflow should run
        default: "ubuntu-latest"
        required: false
        type: string
      workingDirectory:
        description: The directory to run this workflow in
        default: ""
        required: false
        type: string
      terraformDirectory:
        description: The directory to run this workflow in
        default: ""
        required: true
        type: string
      terraformSparseCheckout:
        description: Additional files/patterns for the sparse checkout
        default: ""
        required: false
        type: string
      terraformVars:
        description: The directory to run this workflow in
        default: ""
        required: false
        type: string
      terraformParallelism:
        description: Value for the -parallelism plan/apply flag
        default: 13
        required: false
        type: number
      terraformLogLevel:
        description: Value for the TF_LOG environment value
        default: ""
        required: false
        type: string
      kubeConfigSecret:
        description: The secret name that holds the kubeconfig to connect with Kubernetes
        required: true
        type: string
jobs:
  terraform-diff:
    name: TerraForm Diff
    runs-on: ${{ inputs.runsOn }}
    env:
      TF_LOG: ${{ inputs.terraformLogLevel }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          sparse-checkout-cone-mode: false
          sparse-checkout: |
            !${{ inputs.workingDirectory }}/*
            /${{ inputs.workingDirectory }}${{ inputs.terraformDirectory }}*
            ${{ inputs.terraformSparseCheckout }}
      - name: Put Kubernetes Configuration In Place
        run: |
          mkdir ~/.kube
          printf "$HOME_KUBECONFIG" >> ~/.kube/config
        env:
          HOME_KUBECONFIG: ${{ secrets[inputs.kubeConfigSecret] }}
      - name: Create terraform.tfvars file
        run: |
          cat >> ${{ inputs.terraformDirectory }}terraform.tfvars <<EOL
          ${{ inputs.terraformVars }}
          EOL
          echo "" >> ${{ inputs.terraformDirectory }}terraform.tfvars
        env: ${{ secrets }}
      - name: Init
        run: terraform -chdir=${{ inputs.terraformDirectory }} init -backend-config="access_key=$TERRAFORM_STATE_KEY" -backend-config="secret_key=$TERRAFORM_STATE_SECRET" -backend-config="bucket=$TERRAFORM_STATE_BUCKET" -backend-config="region=$TERRAFORM_STATE_REGION"
        id: init
        env: ${{ secrets }}
      - name: Terraform fmt
        id: fmt
        run: terraform -chdir=${{ inputs.terraformDirectory }} fmt -check
        continue-on-error: true
      - name: Terraform Validate
        id: validate
        run: terraform -chdir=${{ inputs.terraformDirectory }} validate -no-color
      - name: Plan
        id: plan
        run: |
          terraform -chdir=${{ inputs.terraformDirectory }} plan -no-color -parallelism=${{ inputs.terraformParallelism }} -out=/tmp/plan.tmp
          terraform -chdir=${{ inputs.terraformDirectory }} show -no-color /tmp/plan.tmp > /tmp/plan.out
        env: ${{ secrets }}
      - uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        id: planoutput
        with:
          result-encoding: string
          script: |
            const run_url = process.env.GITHUB_SERVER_URL + '/' + process.env.GITHUB_REPOSITORY + '/actions/runs/' + process.env.GITHUB_RUN_ID;
            const run_link = '<a href="' + run_url + '">Actions</a>.';
            const fs = require('fs');
            const plan_file = fs.readFileSync('/tmp/plan.out', 'utf8');
            const plan = plan_file.length > 65000 ? plan_file.toString().substring(0, 65000) + " ..." : plan_file;
            const truncated_message = plan_file.length > 65000 ? "Output is too long and was truncated. You can read full Plan in " + run_link + "<br /><br />" : "";
            return `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            <details><summary>Validation Output</summary>

            \`\`\`\n
            ${{ steps.validate.outputs.stdout }}
            \`\`\`

            </details>

            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`\n
            ${plan}
            \`\`\`

            </details>
            ${truncated_message}`;
      - name: 'Upsert comment'
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          header: terraform-diff
          message: ${{ steps.planoutput.outputs.result }}
